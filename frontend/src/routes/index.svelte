<script>
	import { goto } from '$app/navigation';
	import {onMount} from 'svelte'
	import {authenticated, authrole} from '../stores/auth'
	import {messageStore} from '../stores/chat'
	import MsgList from '../components/chat/MsgList.svelte'

	let name = ''
	let uname = ''
	let data

	let auth, role
	authenticated.subscribe(a => auth = a)
	authrole.subscribe(r => role = r)

	let message = ''
	let messageField

	onMount(async () => {
		try {
			const response = await fetch('http://localhost:8080/auth/user', {
				headers: {'Content-Type': 'application/json'},
				credentials: 'include',
			})
			const content = await response.json()

			if (response.status == 401) {
				name = ''
				$authenticated = false
			} else {
				$authenticated = true
				$authrole = content.role
				
				console.log(role)
				data = content
				
				name = content.name
				uname = content.username
			}
		} catch (error) {
			name = ''
			$authenticated = false
		}
		
	})

	const submit = async () => {
		// tambahin pesan user ke array buat tampilin di ui
		const newMessage = {
			'id': String($messageStore.length),
			'type': 'user',
			'msg': message
		}

		messageStore.update((currentMessage) => {
			return [newMessage, ...currentMessage]
		})

		// panggil api chatbot buat dapetin respons
		const response = await fetch('http://localhost:5005/webhooks/rest/webhook', {
			method: 'POST',
			headers: {'Content-Type': 'application/json'},
			credentials: 'include',
			body: JSON.stringify({
                'sender' : uname,
				'message' : message
            })
		})
		const content = await response.json()

		// tambahin respons bot ke array buat tampilin di ui
		content.forEach(element => {
			let newMessageBot = {
				'id': String($messageStore.length),
				'type': 'bot',
				'msg': element['text']
			}

			messageStore.update((currentMessage) => {
				return [newMessageBot, ...currentMessage]
			})
		});

		// const newMessageBot = {
		// 	'id': String($messageStore.length),
		// 	'type': 'bot',
		// 	'msg': content[0]['text']
		// }

		// messageStore.update((currentMessage) => {
		// 	return [newMessageBot, ...currentMessage]
		// })
		// messages.push({
		// 	'type': 'bot',
		// 	'message': content[0]['text']
		// })
		console.log(content[0]['text'])

		// reset input field
		messageField.value = ''
		console.log($messageStore)
    }

	const logout = async () => {
		await fetch('http://localhost:8080/auth/logout', {
			method: 'POST',
			headers: {'Content-Type': 'application/json'},
			credentials: 'include',
		})
		$authenticated = false
		name = ''
		await goto('/')
	}
</script>

<svelte:head>
	<title>Healthcare Chatbot</title>
</svelte:head>

<div class="bg-gray-50 max-h-screen h-screen w-screen overflow-y-scroll">
	<div class="max-w-2xl mx-auto">
		<header class="mx-auto px-3 max-w-2xl flex items-center justify-between">
			<h1 class="text-xl my-8 w-max inline-block">Halo {name}!</h1>
			<div class="w-max inline-block">
				{#if auth}
					{#if data.role == 'dokter'}<a href="/admin" class="text-purple-600">Admin</a>{/if}
					<button on:click={logout} class="ml-2 text-purple-600">Logout</button>
				{:else}
					<a href="/login" class="text-purple-600">Login</a>
					<a href="/signup" class="ml-2 text-purple-600">Register</a>
				{/if}
			</div>
		</header>
		<main class="mx-auto px-3 max-w-2xl flex flex-col flex-grow">
			<div class="mb-6">
				<div class="inline-flex w-full mb-3">
					<form on:submit|preventDefault={submit} class="inline-flex w-full mb-3">
						{#if !auth}
						<input
							class="px-3 py-3 rounded-md w-full bg-white focus:ring-violet-100 focus:ring-4 transition focus-visible:outline-none"
							type="text"
							name="pesan"
							id="pesan"
							placeholder="Harap login terlebih dahulu"
							disabled
						/>
						<button
							class="bg-violet-700 text-white px-4 rounded-md ml-3 transition" disabled
							>Send</button
						>

						{:else}
						<input
							class="px-3 py-3 rounded-md w-full bg-white focus:ring-violet-100 focus:ring-4 transition focus-visible:outline-none"
							type="text"
							name="pesan"
							id="pesan"
							placeholder="Ketik pesan"
							bind:value={message}
							bind:this={messageField}
						/>
						<button
							class="bg-violet-700 text-white px-4 rounded-md ml-3 hover:drop-shadow hover:bg-violet-500 transition "
							>Send</button
						>
						{/if}
					</form>
				</div>
			</div>

			<MsgList />
		</main>
	</div>
</div>